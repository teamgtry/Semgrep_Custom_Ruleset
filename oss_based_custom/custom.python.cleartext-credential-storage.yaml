rules:
  - id: custom.python.cleartext-credential-storage
    languages: [python]
    severity: ERROR
    message: >
      [Custom Rule] 자격증명으로 추정되는 민감한 데이터가 암호화되지 않은 평문 상태로 디스크에 기록되고 있습니다. 이는 실제로 악용 가능한 취약점이며, 해당 파일이 로그, 백업, 컨테이너 이미지, 빌드 아티팩트 등을 통해 노출될 경우 자격증명 탈취로 이어질 수 있습니다.
    metadata:
      category: security
      cwe: "CWE-522"
      confidence: high
      precision: very-high
      focus: exploitable-only

    mode: taint

    pattern-sources:
      - pattern: secrets.token_hex(...)
      - pattern: secrets.token_bytes(...)
      - pattern: os.urandom(...)

      - patterns:
          - pattern-either:
              - pattern: os.environ[$KEY]
              - pattern: os.environ.get($KEY)
          - metavariable-regex:
              metavariable: $KEY
              regex: '(?i)(token|password|secret|access|auth|api[_-]?key|.*_pwd|pwd_.*)'

      - pattern: get_secret(...)
      - pattern: load_secret(...)
      - pattern: read_secret(...)

    pattern-sinks:
      - patterns:
          - pattern-either:
              - pattern: |
                  with open($FILE, $MODE) as $F:
                    ...
                    $F.write($DATA)
              - pattern: |
                  with open($FILE, $MODE) as $F:
                    ...
                    $F.write(...)
          - metavariable-regex:
              metavariable: $MODE
              regex: '"[wa]b?"'
          - focus-metavariable: $DATA

      - patterns:
          - pattern-either:
              - pattern: open($FILE, $MODE).write($DATA)
              - pattern: $F.write($DATA)
          - metavariable-regex:
              metavariable: $MODE
              regex: '"[wa]b?"'
          - focus-metavariable: $DATA

      - patterns:
          - pattern-either:
              - pattern: Path($FILE).write_text($DATA)
              - pattern: Path($FILE).write_bytes($DATA)
          - focus-metavariable: $DATA

    pattern-sanitizers:
      - pattern: Fernet(...).encrypt(...)

      - pattern: hashlib.$FUNC(...).hexdigest()
      - pattern: hashlib.$FUNC(...).digest()

      - pattern: hmac.new(...).hexdigest()
      - pattern: hmac.new(...).digest()
      - pattern: hmac.HMAC(...).hexdigest()
      - pattern: hmac.HMAC(...).digest()
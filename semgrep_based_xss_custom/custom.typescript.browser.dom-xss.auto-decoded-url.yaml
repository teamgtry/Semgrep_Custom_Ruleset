rules:
  - id: custom.typescript.browser.dom-xss.auto-decoded-url
    message: >
      [Custom Rule] location.search 또는 location.hash에서
      자동 디코딩된 URL 데이터가 타입이 지정된
      DOM HTML 실행 컨텍스트로 전달되고 있습니다.
      강력한 세니타이징이 적용되지 않을 경우,
      DOM 기반 XSS로 실제 악용될 수 있는 고위험 패턴입니다.
    severity: WARNING
    languages: [typescript]
    mode: taint

    metadata:
      category: security
      subcategory: [xss]
      confidence: HIGH
      likelihood: MEDIUM
      impact: MEDIUM
      cwe: ["CWE-79"]
      owasp:
        - A03:2021 - Injection
      technology: [browser, typescript]

    pattern-sources:
      - patterns:
          - pattern-either:
              - pattern: location.search
              - pattern: location.hash
              - pattern: window.location.search
              - pattern: window.location.hash

    pattern-sinks:
      - patterns:
          - pattern-either:
              - pattern: $EL.innerHTML = $X
              - pattern: $EL.innerHTML += $X
          - focus-metavariable: $X
          - metavariable-type:
              metavariable: $EL
              type: HTMLElement

      - patterns:
          - pattern: $EL.outerHTML = $X
          - focus-metavariable: $X
          - metavariable-type:
              metavariable: $EL
              type: Element

      - patterns:
          - pattern-either:
              # DOM APIs
              - pattern: $EL.innerHTML = $X
              - pattern: $EL.innerHTML += $X
              - pattern: $EL.outerHTML = $X
              - pattern: $EL.insertAdjacentHTML("beforeend", $X)
              - pattern: $EL.insertAdjacentHTML("afterbegin", $X)

              - pattern: $($Y).html($X)
              - pattern: $($Y).append($X)
              - pattern: $($Y).prepend($X)
              - pattern: $($Y).before($X)
              - pattern: $($Y).after($X)

              - pattern: jQuery($Y).html($X)
              - pattern: jQuery($Y).append($X)
              - pattern: jQuery($Y).prepend($X)
              - pattern: jQuery($Y).before($X)
              - pattern: jQuery($Y).after($X)

          - focus-metavariable: $X

      - patterns:
          - pattern: $J.html($X)
          - pattern-inside: |
              $J = $($Y)
          - focus-metavariable: $X

      - patterns:
          - pattern: $J.append($X)
          - pattern-inside: |
              $J = $($Y)
          - focus-metavariable: $X

      - patterns:
          - pattern: $J.prepend($X)
          - pattern-inside: |
              $J = $($Y)
          - focus-metavariable: $X

      - patterns:
          - pattern: $J.before($X)
          - pattern-inside: |
              $J = $($Y)
          - focus-metavariable: $X

      - patterns:
          - pattern: $J.after($X)
          - pattern-inside: |
              $J = $($Y)
          - focus-metavariable: $X

    pattern-sanitizers:
      - patterns:
          - pattern-either:
              - pattern: DOMPurify.sanitize(...)
              - pattern: sanitizeHtml(...)